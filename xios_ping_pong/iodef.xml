
<?xml version="1.0"?>
<simulation>

    <context id="model_source">

        <!-- Starting simulation on January 1 -->
        <calendar type="Gregorian" time_origin="2025-01-01" start_date="2025-01-01"/>

        <!-- Domain definition for the source model -->
        <grid_definition>
            <grid id="grid_2D">
                <domain id="domain_model_src"/>
            </grid>
        </grid_definition>

        <!-- Toymodels attributes, not in real model coupling -->
        <variable_definition>
            <variable id="toymodel_timestep_duration">1d</variable>
            <variable id="toymodel_duration">30d</variable>
            <variable id="toymodel_grids_filename">points_files/grids.nc</variable>
            <variable id="toymodel_masks_filename">points_files/masks.nc</variable>
            <variable id="toymodel_areas_filename">points_files/areas.nc</variable>
            <!-- <variable id="toymodel_src_domain_name">bggd</variable>
            <variable id="toymodel_dst_domain_name">nogt</variable> -->
            <variable id="toymodel_src_domain_name">nogt</variable>
            <variable id="toymodel_dst_domain_name">bggd</variable>
        </variable_definition>


        <!-- Field definition for the source model -->
        <field_definition>
            <!-- Endpoint to send field to destination in toymodel -->
            <field id="field2D_send" grid_ref="grid_2D"  operation="instant" freq_op="1ts" freq_offset="0ts"/>
        </field_definition>

        <coupler_out_definition>
            <coupler_out context="model_destination::model_destination" >
                <!-- Define the interface for the outgoing field to be received in atmosphere -->
                <field id="field2D_cpl" field_ref="field2D_send" freq_op="5ts" expr="@this_ref"/>
                <field id="field2D_cpl_restart" field_ref="field2D_restart" freq_op="1y" />
            </coupler_out>
        </coupler_out_definition>

        <file_definition>
            <!-- Save field on the last send -->
            <file id="last_send" name="last_send" output_freq="30d"  type="one_file" enabled="true">
                <field field_ref="field2D_cpl"  operation="instant" />
            </file>
            <!-- Restarting field -->
            <file id="restart_file" name="restart_file" output_freq="1y"  type="one_file" enabled="true" mode="read">
                <field id="field2D_restart" name="field2D_cpl" grid_ref="grid_2D" operation="instant" read_access="true"/>
            </file>
        </file_definition>

    </context>


    <context id="model_destination">

        <calendar type="Gregorian" time_origin="2025-01-01" start_date="2025-01-01"/>

        <grid_definition>
            <!-- Intermediate grid inferred by incoming field -->
            <grid id="grid_2D">
                <domain id="domain_src"> <!-- Arbitrary name in this example, not used -->
                </domain>
            </grid>

            <!-- Grid onto which the field will be interpolated -->
            <grid id="grid_2D_interp">
                <domain id="domain_interp">
                    <!-- Interpolation attributes -->
                    <interpolate_domain order="1" renormalize="true" use_area="true" weight_filename="points_files/nogt_bggd.nc"  mode="read_or_compute" write_weight="true"/>
                </domain>
            </grid>

        </grid_definition>

        <!-- Toymodels attributes, not in real model coupling -->
        <variable_definition>
            <variable id="toymodel_timestep_duration">1d</variable>
            <variable id="toymodel_duration">30d</variable>
            <variable id="toymodel_grids_filename">points_files/grids.nc</variable>
            <variable id="toymodel_masks_filename">points_files/masks.nc</variable>
            <variable id="toymodel_areas_filename">points_files/areas.nc</variable>
            <!-- <variable id="toymodel_src_domain_name">bggd</variable>
            <variable id="toymodel_dst_domain_name">nogt</variable> -->
            <variable id="toymodel_src_domain_name">nogt</variable>
            <variable id="toymodel_dst_domain_name">bggd</variable>
        </variable_definition>


        <field_definition default_value="0" grid_ref="grid_2D_interp" >
            <!-- Endpoint to retrieve interpolated field on toymodel -->
            <field id="field2D_recv" field_ref="field2D_cpl" />
            <field id="field2D_recv_restart" field_ref="field2D_cpl_restart"/>
        </field_definition>

        <!-- Incoming coupling definition -->
        <coupler_in_definition>
            <coupler_in context="model_source::model_source" >
                <!-- Interface for the incoming field to be received in destination (same field id)-->
                <field id="field2D_cpl" grid_ref="grid_2D" freq_op="5ts" freq_offset="6ts" read_access="true"/>
                <field id="field2D_cpl_restart" grid_ref="grid_2D" freq_op="1y" freq_offset="1ts" operation="instant" read_access="true"/>
            </coupler_in>
        </coupler_in_definition>

        <file_definition>
            <file id="interpolated_field"  output_freq="5ts"  type="one_file" enabled="true">
                <field field_ref="field2D_recv" name="interpolated_field" operation="instant" />
            </file>
        </file_definition>

    </context>


  <!-- XIOS server parameters -->
  <context id="xios">
     <variable_definition>
        <variable_group id="parameters" >
          <variable id="print_file" type="bool">true</variable>
          <!-- <variable id="info_level" type="int">100</variable> -->
          <variable id="transport_protocol" type="string">p2p</variable>
        </variable_group>
     </variable_definition>
  </context>

</simulation>
